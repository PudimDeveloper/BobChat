<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BobChat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none;}
:root{
  --bg:#08080f;--s1:#0f0f1a;--s2:#161625;--s3:#1e1e30;--s4:#26263c;
  --acc:#a78bfa;--acc2:#f472b6;--acc3:#34d399;--acc4:#fb923c;
  --t1:#f0f0ff;--t2:#9090b0;--t3:#5050708;
  --border:rgba(255,255,255,0.06);--glow:rgba(167,139,250,0.25);
  --r:16px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--t1);font-family:'Outfit',sans-serif;}
button,input,textarea{font-family:'Outfit',sans-serif;}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--s4);border-radius:4px;}

/* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ */
#splash{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;z-index:9999;transition:opacity .4s;}
#splash.hide{opacity:0;pointer-events:none;}
.splash-logo{font-size:3rem;font-weight:900;background:linear-gradient(135deg,var(--acc),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.splash-sub{color:var(--t2);font-size:.9rem;}
.spinner{width:32px;height:32px;border:2px solid var(--s4);border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#authScreen{position:fixed;inset:0;background:var(--bg);display:none;align-items:center;justify-content:center;z-index:900;overflow-y:auto;}
#authScreen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 70% 50% at 50% 20%,rgba(167,139,250,.12) 0%,transparent 70%);pointer-events:none;}
.auth-box{background:var(--s1);border:1px solid var(--border);border-radius:24px;padding:2.5rem 2rem;width:min(380px,92vw);position:relative;z-index:1;box-shadow:0 0 80px rgba(167,139,250,.08);}
.auth-logo{text-align:center;margin-bottom:2rem;}
.auth-logo h1{font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,var(--acc),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.auth-logo p{color:var(--t2);font-size:.85rem;margin-top:.3rem;}
.auth-field{margin-bottom:1rem;}
.auth-field label{display:block;font-size:.78rem;color:var(--t2);margin-bottom:.4rem;font-weight:500;}
.auth-field input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:.8rem 1rem;color:var(--t1);font-size:.9rem;transition:.2s;}
.auth-field input:focus{border-color:var(--acc);box-shadow:0 0 0 3px var(--glow);}
.auth-btn{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:12px;padding:.9rem;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;transition:.2s;margin-top:.5rem;}
.auth-btn:hover{opacity:.9;transform:translateY(-1px);}
.auth-err{color:#f87171;font-size:.8rem;text-align:center;margin-top:.7rem;display:none;}
.auth-note{text-align:center;color:var(--t2);font-size:.78rem;margin-top:1rem;}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#app{display:none;height:100vh;flex-direction:column;}
#app.on{display:flex;}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bnav{display:flex;background:var(--s1);border-top:1px solid var(--border);flex-shrink:0;padding-bottom:env(safe-area-inset-bottom);}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.6rem .3rem;background:none;border:none;color:var(--t2);font-size:.65rem;font-weight:600;cursor:pointer;transition:.15s;gap:.25rem;position:relative;}
.bnav-btn .icon{font-size:1.3rem;transition:.2s;}
.bnav-btn.active{color:var(--acc);}
.bnav-btn.active .icon{transform:scale(1.15);}
.bnav-badge{position:absolute;top:.4rem;right:calc(50% - 14px);background:var(--acc2);color:#fff;border-radius:10px;font-size:.6rem;font-weight:700;padding:.1rem .35rem;min-width:16px;text-align:center;}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{flex:1;overflow-y:auto;display:none;flex-direction:column;}
.page.active{display:flex;}
.page-header{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1rem;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;position:sticky;top:0;z-index:10;}
.page-title{font-size:1.1rem;font-weight:800;}
.icon-btn{background:none;border:none;color:var(--t2);cursor:pointer;font-size:1.2rem;padding:.4rem;border-radius:10px;transition:.15s;display:flex;align-items:center;justify-content:center;}
.icon-btn:hover{color:var(--t1);background:var(--s3);}

/* ‚îÄ‚îÄ STORIES ‚îÄ‚îÄ */
#storiesPage{background:var(--bg);}
.stories-top{padding:.8rem;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
.stories-bubbles{display:flex;gap:.7rem;overflow-x:auto;padding:.3rem 0;padding-bottom:.5rem;}
.stories-bubbles::-webkit-scrollbar{height:0;}
.s-bubble{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:.3rem;cursor:pointer;}
.s-ring{width:60px;height:60px;border-radius:50%;padding:2.5px;background:linear-gradient(135deg,var(--acc),var(--acc2));}
.s-ring.seen{background:var(--s4);}
.s-ring.mine{background:linear-gradient(135deg,var(--acc3),#06b6d4);}
.s-ring-inner{width:100%;height:100%;border-radius:50%;background:var(--s2);border:2px solid var(--bg);overflow:hidden;display:flex;align-items:center;justify-content:center;}
.s-ring-inner img{width:100%;height:100%;object-fit:cover;}
.s-bubble-name{font-size:.65rem;color:var(--t2);max-width:60px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.s-add-btn{width:60px;height:60px;border-radius:50%;background:var(--s3);border:2px dashed var(--s4);display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;transition:.2s;flex-shrink:0;}
.s-add-btn:hover{border-color:var(--acc);color:var(--acc);}
.stories-feed{padding:.8rem;display:flex;flex-direction:column;gap:.8rem;}
.story-card{background:var(--s1);border:1px solid var(--border);border-radius:20px;overflow:hidden;cursor:pointer;transition:.2s;position:relative;}
.story-card:hover{border-color:rgba(167,139,250,.3);transform:translateY(-2px);box-shadow:0 8px 30px rgba(167,139,250,.1);}
.story-card-media{width:100%;aspect-ratio:16/9;background:var(--s2);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
.story-card-media img{width:100%;height:100%;object-fit:cover;}
.story-card-body{padding:.9rem;}
.story-card-user{display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;}
.story-card-user strong{font-size:.9rem;}
.story-card-user small{color:var(--t2);font-size:.75rem;margin-left:auto;}
.story-card-text{font-size:.88rem;line-height:1.5;color:var(--t1);margin-bottom:.7rem;}
.story-card-actions{display:flex;align-items:center;gap:1rem;}
.like-btn{display:flex;align-items:center;gap:.35rem;background:none;border:none;color:var(--t2);cursor:pointer;font-size:.85rem;padding:.3rem .6rem;border-radius:8px;transition:.15s;}
.like-btn:hover{color:var(--acc2);}
.like-btn.liked{color:var(--acc2);}
.like-btn .heart{transition:.2s;}
.like-btn.liked .heart{transform:scale(1.3);}
.views-count{color:var(--t2);font-size:.8rem;display:flex;align-items:center;gap:.3rem;cursor:pointer;}
.views-count:hover{color:var(--t1);}

/* ‚îÄ‚îÄ STORY VIEWER ‚îÄ‚îÄ */
#storyViewer{position:fixed;inset:0;background:#000;z-index:800;display:none;flex-direction:column;}
#storyViewer.open{display:flex;}
.sv-progress{display:flex;gap:3px;padding:.7rem .7rem .3rem;position:absolute;top:0;left:0;right:0;z-index:2;}
.sv-prog-bar{flex:1;height:2.5px;background:rgba(255,255,255,.3);border-radius:4px;overflow:hidden;}
.sv-prog-fill{height:100%;background:#fff;width:0;transition:none;}
.sv-header{position:absolute;top:2.5rem;left:0;right:0;z-index:2;padding:.5rem .8rem;display:flex;align-items:center;gap:.6rem;}
.sv-close{position:absolute;top:.7rem;right:.8rem;z-index:3;background:rgba(0,0,0,.5);border:none;color:#fff;font-size:1.1rem;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.sv-media{flex:1;display:flex;align-items:center;justify-content:center;position:relative;}
.sv-media img{max-width:100%;max-height:100%;object-fit:contain;}
.sv-text-only{color:#fff;font-size:1.3rem;text-align:center;padding:2rem;font-weight:600;}
.sv-nav-left{position:absolute;left:0;top:0;width:40%;height:100%;cursor:pointer;z-index:1;}
.sv-nav-right{position:absolute;right:0;top:0;width:40%;height:100%;cursor:pointer;z-index:1;}
.sv-footer{background:linear-gradient(to top,rgba(0,0,0,.8),transparent);padding:1.2rem .8rem;display:flex;align-items:center;gap:.8rem;}
.sv-like-btn{background:none;border:none;color:#fff;font-size:1.4rem;cursor:pointer;transition:.2s;}
.sv-like-btn.liked{color:#f472b6;}
.sv-likes{color:#fff;font-size:.85rem;}
.sv-viewers{color:rgba(255,255,255,.6);font-size:.8rem;cursor:pointer;margin-left:auto;}
.sv-bg{position:absolute;inset:0;background:var(--bg);}

/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
#chatPage{background:var(--bg);}
.chat-search{padding:.7rem 1rem;background:var(--s1);border-bottom:1px solid var(--border);}
.chat-search input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:.6rem .9rem;color:var(--t1);font-size:.88rem;}
.chat-search input:focus{border-color:var(--acc);}
.chat-list-items{flex:1;overflow-y:auto;}
.chat-item{display:flex;align-items:center;gap:.8rem;padding:.8rem 1rem;cursor:pointer;transition:.15s;border-bottom:1px solid var(--border);position:relative;}
.chat-item:hover{background:var(--s2);}
.chat-item-info{flex:1;min-width:0;}
.chat-item-info strong{display:block;font-size:.9rem;font-weight:600;}
.chat-item-info small{color:var(--t2);font-size:.78rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;margin-top:.1rem;}
.chat-item-meta{display:flex;flex-direction:column;align-items:flex-end;gap:.3rem;flex-shrink:0;}
.chat-item-meta time{color:var(--t2);font-size:.7rem;}
.unread-badge{background:var(--acc);color:#fff;border-radius:10px;font-size:.65rem;font-weight:700;padding:.1rem .4rem;min-width:18px;text-align:center;}
.chat-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.6rem;color:var(--t2);}
.chat-empty span{font-size:3rem;}
.chat-empty p{font-size:.9rem;}

/* ‚îÄ‚îÄ CHAT WINDOW ‚îÄ‚îÄ */
#chatWin{position:fixed;inset:0;background:var(--bg);z-index:700;display:none;flex-direction:column;}
#chatWin.open{display:flex;}
.cw-header{display:flex;align-items:center;gap:.7rem;padding:.7rem .8rem;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
.cw-header-info{flex:1;min-width:0;cursor:pointer;}
.cw-header-info strong{display:block;font-size:.95rem;font-weight:700;}
.cw-header-info small{color:var(--t2);font-size:.75rem;}
.cw-back{background:none;border:none;color:var(--t2);font-size:1.2rem;cursor:pointer;padding:.3rem;}
.cw-msgs{flex:1;overflow-y:auto;padding:.8rem;display:flex;flex-direction:column;gap:.5rem;}
.msg-bubble{max-width:75%;display:flex;flex-direction:column;}
.msg-bubble.me{align-self:flex-end;}
.msg-bubble.them{align-self:flex-start;}
.msg-inner{padding:.6rem .9rem;border-radius:16px;font-size:.88rem;line-height:1.45;word-break:break-word;}
.msg-bubble.me .msg-inner{background:linear-gradient(135deg,var(--acc),rgba(167,139,250,.7));color:#fff;border-radius:16px 16px 4px 16px;}
.msg-bubble.them .msg-inner{background:var(--s2);border-radius:16px 16px 16px 4px;}
.msg-sticker{max-width:160px;border-radius:12px;cursor:pointer;}
.msg-time{font-size:.62rem;color:var(--t2);margin-top:.2rem;padding:0 .4rem;}
.msg-bubble.me .msg-time{text-align:right;}
.cw-input-area{padding:.6rem .8rem;background:var(--s1);border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:.5rem;flex-shrink:0;padding-bottom:max(.6rem,env(safe-area-inset-bottom));}
.cw-input{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:.55rem 1rem;color:var(--t1);font-size:.9rem;resize:none;max-height:100px;overflow-y:auto;line-height:1.4;}
.cw-input:focus{border-color:var(--acc);}
.cw-send{background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:50%;width:38px;height:38px;color:#fff;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;flex-shrink:0;}
.cw-send:hover{opacity:.85;}

/* ‚îÄ‚îÄ GROUP WINDOW ‚îÄ‚îÄ */
#groupWin{position:fixed;inset:0;background:var(--bg);z-index:700;display:none;flex-direction:column;}
#groupWin.open{display:flex;}

/* ‚îÄ‚îÄ GAMES ‚îÄ‚îÄ */
#gamesPage{background:var(--bg);}
.games-grid{padding:1rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.8rem;}
.game-card{background:var(--s1);border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:.2s;}
.game-card:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(167,139,250,.15);border-color:rgba(167,139,250,.3);}
.game-card-thumb{width:100%;aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:3rem;background:var(--s2);}
.game-card-info{padding:.7rem;}
.game-card-info strong{display:block;font-size:.88rem;font-weight:700;}
.game-card-info small{color:var(--t2);font-size:.72rem;}
.beta-badge{background:var(--s4);color:var(--t2);border-radius:6px;font-size:.62rem;font-weight:700;padding:.15rem .4rem;margin-left:.4rem;}
.leaderboard-section{padding:1rem;}
.leaderboard-title{font-size:1rem;font-weight:800;margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem;}
.lb-item{display:flex;align-items:center;gap:.7rem;padding:.7rem .9rem;background:var(--s1);border:1px solid var(--border);border-radius:12px;margin-bottom:.5rem;transition:.2s;}
.lb-item:hover{border-color:rgba(167,139,250,.2);}
.lb-rank{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:.85rem;width:20px;text-align:center;}
.lb-rank.gold{color:#fbbf24;}
.lb-rank.silver{color:#94a3b8;}
.lb-rank.bronze{color:#fb923c;}
.lb-score{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--acc);}

/* ‚îÄ‚îÄ FLAPPY BIRD ‚îÄ‚îÄ */
#flappyWin{position:fixed;inset:0;background:#1a2a1a;z-index:750;display:none;flex-direction:column;}
#flappyWin.open{display:flex;}
.flappy-header{display:flex;align-items:center;gap:.7rem;padding:.7rem .9rem;background:rgba(0,0,0,.5);flex-shrink:0;}
#flappyCanvas{flex:1;width:100%;display:block;}
.flappy-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;pointer-events:none;}
.flappy-overlay.hidden{display:none;}
.flappy-title{font-size:2rem;font-weight:900;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.5);}
.flappy-score-big{font-size:3rem;font-weight:900;color:#fbbf24;font-family:'JetBrains Mono',monospace;}
.flappy-tap{color:rgba(255,255,255,.8);font-size:1rem;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.flappy-start-btn{background:linear-gradient(135deg,#fbbf24,#f59e0b);border:none;border-radius:12px;padding:.8rem 2rem;color:#000;font-size:1rem;font-weight:800;cursor:pointer;pointer-events:all;}
#flappyScore{position:absolute;top:60px;left:50%;transform:translateX(-50%);font-size:2rem;font-weight:900;color:#fff;font-family:'JetBrains Mono',monospace;text-shadow:0 2px 8px rgba(0,0,0,.7);pointer-events:none;}

/* ‚îÄ‚îÄ STICKERS ‚îÄ‚îÄ */
#stickersPage{background:var(--bg);}
.stickers-upload-zone{margin:1rem;border:2px dashed var(--s4);border-radius:16px;padding:2rem;text-align:center;cursor:pointer;transition:.2s;}
.stickers-upload-zone:hover{border-color:var(--acc);}
.stickers-upload-zone span{font-size:2.5rem;display:block;margin-bottom:.5rem;}
.stickers-grid{padding:.5rem 1rem 1rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.6rem;}
.sticker-item{border-radius:12px;overflow:hidden;aspect-ratio:1;background:var(--s2);cursor:pointer;position:relative;transition:.2s;}
.sticker-item:hover{transform:scale(1.05);}
.sticker-item img{width:100%;height:100%;object-fit:cover;}
.sticker-del{position:absolute;top:.25rem;right:.25rem;background:rgba(0,0,0,.7);border:none;color:#fff;width:22px;height:22px;border-radius:50%;font-size:.75rem;cursor:pointer;display:none;align-items:center;justify-content:center;}
.sticker-item:hover .sticker-del{display:flex;}

/* ‚îÄ‚îÄ STICKER PICKER ‚îÄ‚îÄ */
#stickerPicker{position:fixed;bottom:0;left:0;right:0;background:var(--s1);border-top:1px solid var(--border);border-radius:20px 20px 0 0;z-index:710;display:none;max-height:50vh;flex-direction:column;padding-bottom:env(safe-area-inset-bottom);}
#stickerPicker.open{display:flex;}
.sp-handle{width:36px;height:4px;background:var(--s4);border-radius:4px;margin:.7rem auto .5rem;}
.sp-title{padding:.3rem 1rem .5rem;font-size:.85rem;font-weight:700;color:var(--t2);}
.sp-grid{padding:.5rem 1rem 1rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:.5rem;overflow-y:auto;}
.sp-item{border-radius:10px;overflow:hidden;aspect-ratio:1;background:var(--s2);cursor:pointer;transition:.2s;}
.sp-item:hover{transform:scale(1.08);}
.sp-item img{width:100%;height:100%;object-fit:cover;}
.sp-empty{text-align:center;color:var(--t2);font-size:.85rem;padding:1rem;grid-column:1/-1;}

/* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
#profilePage{background:var(--bg);}
.profile-top{padding:1.5rem 1rem;display:flex;flex-direction:column;align-items:center;gap:.8rem;background:var(--s1);border-bottom:1px solid var(--border);}
.profile-avatar-wrap{position:relative;cursor:pointer;}
.profile-avatar-wrap .edit-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);border-radius:50%;display:none;align-items:center;justify-content:center;font-size:1.2rem;color:#fff;}
.profile-avatar-wrap:hover .edit-overlay{display:flex;}
.profile-name{font-size:1.3rem;font-weight:800;}
.profile-bio-edit{background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:.6rem .9rem;color:var(--t1);font-size:.88rem;width:100%;max-width:300px;text-align:center;resize:none;}
.profile-bio-edit:focus{border-color:var(--acc);}
.profile-save-btn{background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:10px;color:#fff;padding:.5rem 1.5rem;font-size:.88rem;font-weight:700;cursor:pointer;}
.profile-stats{display:flex;justify-content:center;gap:2rem;padding:1rem;}
.stat-item{text-align:center;}
.stat-item strong{display:block;font-size:1.2rem;font-weight:800;}
.stat-item small{color:var(--t2);font-size:.75rem;}
.profile-friends-section{padding:1rem;}
.friends-title{font-size:.9rem;font-weight:700;margin-bottom:.8rem;}
.friend-chip{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;background:var(--s1);border:1px solid var(--border);border-radius:12px;margin-bottom:.5rem;cursor:pointer;transition:.15s;}
.friend-chip:hover{border-color:rgba(167,139,250,.3);}

/* ‚îÄ‚îÄ AVATAR ‚îÄ‚îÄ */
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden;flex-shrink:0;}
.avatar img{width:100%;height:100%;object-fit:cover;}
.avatar.sz-sm{width:32px;height:32px;font-size:.78rem;}
.avatar.sz-md{width:42px;height:42px;font-size:.9rem;}
.avatar.sz-lg{width:60px;height:60px;font-size:1.1rem;}
.avatar.sz-xl{width:80px;height:80px;font-size:1.4rem;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:800;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
.modal.open{display:flex;}
.modal.center{align-items:center;}
.modal-box{background:var(--s1);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:1.5rem;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;}
.modal.center .modal-box{border-radius:24px;width:min(420px,92vw);}
.modal-drag{width:36px;height:4px;background:var(--s4);border-radius:4px;margin:0 auto .8rem;}
.modal-title{font-size:1.1rem;font-weight:800;margin-bottom:1rem;}
.modal-close{float:right;background:none;border:none;color:var(--t2);font-size:1.1rem;cursor:pointer;margin-top:-.2rem;}
.modal-field{margin-bottom:.9rem;}
.modal-field label{display:block;font-size:.78rem;color:var(--t2);margin-bottom:.4rem;}
.modal-field input,.modal-field textarea{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:.7rem .9rem;color:var(--t1);font-size:.88rem;}
.modal-field input:focus,.modal-field textarea:focus{border-color:var(--acc);}
.modal-btn{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:12px;padding:.8rem;color:#fff;font-size:.95rem;font-weight:700;cursor:pointer;transition:.2s;margin-top:.3rem;}
.modal-btn:hover{opacity:.9;}
.modal-btn.secondary{background:var(--s3);color:var(--t2);margin-top:.5rem;}

/* ‚îÄ‚îÄ PROFILE VIEW ‚îÄ‚îÄ */
#profileView{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:810;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
#profileView.open{display:flex;}
.pv-box{background:var(--s1);border:1px solid var(--border);border-radius:24px;padding:2rem 1.5rem;width:min(340px,90vw);text-align:center;display:flex;flex-direction:column;align-items:center;gap:.7rem;}
.pv-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--t2);font-size:1.2rem;cursor:pointer;}
.pv-name{font-size:1.3rem;font-weight:800;}
.pv-bio{color:var(--t2);font-size:.85rem;line-height:1.5;}
.pv-actions{display:flex;gap:.6rem;margin-top:.5rem;}
.pv-add-btn{background:var(--acc);border:none;border-radius:10px;color:#fff;padding:.5rem 1.2rem;font-size:.85rem;font-weight:700;cursor:pointer;transition:.2s;}
.pv-add-btn:hover{opacity:.85;}
.pv-msg-btn{background:var(--s3);border:none;border-radius:10px;color:var(--t1);padding:.5rem 1.2rem;font-size:.85rem;font-weight:700;cursor:pointer;transition:.2s;}
.pv-msg-btn:hover{background:var(--s4);}

/* ‚îÄ‚îÄ WHO LIKED/VIEWED ‚îÄ‚îÄ */
.who-list{display:flex;flex-direction:column;gap:.6rem;max-height:50vh;overflow-y:auto;}
.who-item{display:flex;align-items:center;gap:.7rem;padding:.5rem 0;}
.who-item strong{font-size:.88rem;}

/* ‚îÄ‚îÄ ADD FRIEND ‚îÄ‚îÄ */
.find-user-result{background:var(--s2);border-radius:12px;padding:.8rem;display:flex;align-items:center;gap:.7rem;margin-top:.7rem;}
.find-user-result strong{flex:1;}

/* ‚îÄ‚îÄ GROUP CREATION ‚îÄ‚îÄ */
.member-list-pick{display:flex;flex-direction:column;gap:.4rem;max-height:200px;overflow-y:auto;margin-top:.5rem;}
.member-pick-item{display:flex;align-items:center;gap:.7rem;padding:.5rem;border-radius:10px;cursor:pointer;transition:.15s;}
.member-pick-item:hover{background:var(--s2);}
.member-pick-item input[type=checkbox]{width:16px;height:16px;accent-color:var(--acc);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--s3);border:1px solid var(--border);border-radius:12px;padding:.6rem 1.2rem;font-size:.85rem;color:var(--t1);z-index:999;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap;}
#toast.show{opacity:1;}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.divider{height:1px;background:var(--border);margin:.5rem 0;}
.text-acc{color:var(--acc);}
.empty-s{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.5rem;color:var(--t2);padding:2rem;}
.empty-s span{font-size:3rem;}
.group-badge{background:var(--acc4);color:#000;border-radius:6px;font-size:.62rem;font-weight:800;padding:.1rem .35rem;}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-logo">BobChat</div>
  <div class="splash-sub">Carregando...</div>
  <div class="spinner"></div>
</div>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">
      <h1>BobChat</h1>
      <p>S√≥ pra galera üíú</p>
    </div>
    <div class="auth-field"><label>Seu nome</label><input id="authName" placeholder="Ex: Bob" autocomplete="username"></div>
    <div class="auth-field"><label>Senha</label><input id="authPass" type="password" placeholder="Senha secreta" autocomplete="current-password"></div>
    <button class="auth-btn" id="authSubmit" onclick="doAuth()">Entrar / Criar conta</button>
    <p class="auth-err" id="authErr"></p>
    <p class="auth-note">Conta nova? Ela √© criada automaticamente ‚ú®</p>
  </div>
</div>

<!-- APP -->
<div id="app">

  <!-- STORIES PAGE -->
  <div class="page active" id="storiesPage">
    <div class="page-header">
      <div class="page-title">BobChat</div>
      <button class="icon-btn" onclick="openAddFriendModal()">üë•</button>
    </div>
    <div class="stories-top">
      <div class="stories-bubbles" id="storiesBubbles">
        <div class="s-add-btn" onclick="openPostStoryModal()" title="Postar story">Ôºã</div>
      </div>
    </div>
    <div class="stories-feed" id="storiesFeed"></div>
  </div>

  <!-- CHAT PAGE -->
  <div class="page" id="chatPage">
    <div class="page-header">
      <div class="page-title">Conversas</div>
      <button class="icon-btn" onclick="openCreateGroupModal()">Ôºã Grupo</button>
    </div>
    <div class="chat-search"><input id="chatSearch" placeholder="üîç Pesquisar..." oninput="filterChats(this.value)"></div>
    <div class="chat-list-items" id="chatListItems">
      <div class="chat-empty" id="chatEmpty"><span>üí¨</span><p>Adicione amigos para conversar</p></div>
    </div>
  </div>

  <!-- GAMES PAGE -->
  <div class="page" id="gamesPage">
    <div class="page-header"><div class="page-title">Jogos üéÆ</div></div>
    <div class="games-grid">
      <div class="game-card" onclick="openFlappy()">
        <div class="game-card-thumb">üê¶</div>
        <div class="game-card-info"><strong>Flappy Bird</strong><small>Desvia dos canos!</small></div>
      </div>
      <div class="game-card" style="opacity:.6;cursor:default">
        <div class="game-card-thumb">üß©</div>
        <div class="game-card-info"><strong>Puzzle <span class="beta-badge">BETA</span></strong><small>Em breve</small></div>
      </div>
      <div class="game-card" style="opacity:.6;cursor:default">
        <div class="game-card-thumb">‚ö°</div>
        <div class="game-card-info"><strong>Speed Quiz <span class="beta-badge">BETA</span></strong><small>Em breve</small></div>
      </div>
    </div>
    <div class="leaderboard-section">
      <div class="leaderboard-title">üèÜ Ranking ‚Äî Flappy Bird</div>
      <div id="leaderboardList"></div>
    </div>
  </div>

  <!-- STICKERS PAGE -->
  <div class="page" id="stickersPage">
    <div class="page-header"><div class="page-title">Figurinhas üé®</div></div>
    <label class="stickers-upload-zone" for="stickerUploadInput">
      <span>üìÅ</span><p>Toque para adicionar da galeria</p>
      <input type="file" id="stickerUploadInput" accept="image/*" style="display:none" onchange="uploadSticker(this)">
    </label>
    <div class="stickers-grid" id="stickersGrid"></div>
  </div>

  <!-- PROFILE PAGE -->
  <div class="page" id="profilePage">
    <div class="page-header"><div class="page-title">Perfil</div><button class="icon-btn" onclick="doLogout()">üö™</button></div>
    <div class="profile-top">
      <div class="profile-avatar-wrap" onclick="document.getElementById('avatarInput').click()">
        <div class="avatar sz-xl" id="profileAvatarDisplay"></div>
        <div class="edit-overlay">‚úèÔ∏è</div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
      </div>
      <div class="profile-name" id="profileNameDisplay"></div>
      <textarea class="profile-bio-edit" id="profileBioInput" placeholder="Sua bio..." rows="2" maxlength="120"></textarea>
      <button class="profile-save-btn" onclick="saveBio()">Salvar bio</button>
    </div>
    <div class="profile-stats">
      <div class="stat-item"><strong id="statStories">0</strong><small>Stories</small></div>
      <div class="stat-item"><strong id="statFriends">0</strong><small>Amigos</small></div>
      <div class="stat-item"><strong id="statScore">0</strong><small>Pts jogos</small></div>
    </div>
    <div class="profile-friends-section">
      <div class="friends-title">Amigos</div>
      <div id="friendsList"></div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bnav">
    <button class="bnav-btn active" onclick="showPage('storiesPage',this)"><span class="icon">üìñ</span>Stories</button>
    <button class="bnav-btn" onclick="showPage('chatPage',this)"><span class="icon">üí¨</span>Chat<span class="bnav-badge" id="msgBadge" style="display:none">0</span></button>
    <button class="bnav-btn" onclick="showPage('gamesPage',this);loadLeaderboard()"><span class="icon">üéÆ</span>Jogos</button>
    <button class="bnav-btn" onclick="showPage('stickersPage',this);renderStickersPage()"><span class="icon">üé®</span>Figurinhas</button>
    <button class="bnav-btn" onclick="showPage('profilePage',this);renderProfilePage()"><span class="icon">üë§</span>Perfil</button>
  </nav>
</div>

<!-- CHAT WINDOW -->
<div id="chatWin">
  <div class="cw-header">
    <button class="cw-back" onclick="closeChatWin()">‚Üê</button>
    <div id="cwAvatarWrap"></div>
    <div class="cw-header-info" id="cwHeaderInfo" onclick="openChatHeaderProfile()">
      <strong id="cwName"></strong>
      <small id="cwStatus">online</small>
    </div>
    <button class="icon-btn" id="cwStickerBtn" onclick="openStickerPicker()">üé®</button>
  </div>
  <div class="cw-msgs" id="cwMsgs"></div>
  <div class="cw-input-area">
    <textarea class="cw-input" id="cwInput" placeholder="Mensagem..." rows="1"
      oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"></textarea>
    <button class="cw-send" onclick="sendMsg()">‚û§</button>
  </div>
</div>

<!-- GROUP WINDOW -->
<div id="groupWin">
  <div class="cw-header">
    <button class="cw-back" onclick="closeGroupWin()">‚Üê</button>
    <div id="gwAvatarWrap"></div>
    <div class="cw-header-info" id="gwHeaderInfo" onclick="openGroupInfo()">
      <strong id="gwName"></strong>
      <small id="gwStatus"></small>
    </div>
    <button class="icon-btn" onclick="openStickerPickerGroup()">üé®</button>
  </div>
  <div class="cw-msgs" id="gwMsgs"></div>
  <div class="cw-input-area">
    <textarea class="cw-input" id="gwInput" placeholder="Mensagem no grupo..." rows="1"
      oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendGroupMsg();}"></textarea>
    <button class="cw-send" onclick="sendGroupMsg()">‚û§</button>
  </div>
</div>

<!-- FLAPPY BIRD -->
<div id="flappyWin">
  <div class="flappy-header" style="display:flex;align-items:center;gap:.7rem;">
    <button class="cw-back" onclick="closeFlappy()">‚Üê</button>
    <strong style="color:#fff">Flappy Bird</strong>
  </div>
  <div style="position:relative;flex:1;display:flex;">
    <canvas id="flappyCanvas"></canvas>
    <div id="flappyOverlay" class="flappy-overlay">
      <div class="flappy-title">üê¶ Flappy Bird</div>
      <div class="flappy-score-big" id="flappyFinalScore" style="display:none"></div>
      <button class="flappy-start-btn" id="flappyStartBtn" onclick="startFlappy()">Toque para jogar</button>
    </div>
    <div id="flappyScore" style="display:none">0</div>
  </div>
</div>

<!-- STORY VIEWER -->
<div id="storyViewer">
  <div class="sv-progress" id="svProgress"></div>
  <button class="sv-close" onclick="closeSV()">‚úï</button>
  <div class="sv-header" id="svHeader"></div>
  <div class="sv-media">
    <div class="sv-bg"></div>
    <div class="sv-nav-left" onclick="svPrev()"></div>
    <div class="sv-nav-right" onclick="svNext()"></div>
    <img id="svImg" style="display:none;position:relative;z-index:1;max-width:100%;max-height:85vh;">
    <div id="svText" class="sv-text-only" style="position:relative;z-index:1;"></div>
  </div>
  <div class="sv-footer">
    <button class="sv-like-btn" id="svLikeBtn" onclick="toggleSVLike()">ü§ç</button>
    <span class="sv-likes" id="svLikesCount"></span>
    <span class="sv-viewers" id="svViewersCount" onclick="showWhoViewed()">üëÅ</span>
  </div>
</div>

<!-- STICKER PICKER -->
<div id="stickerPicker">
  <div class="sp-handle"></div>
  <div class="sp-title">Suas figurinhas</div>
  <div class="sp-grid" id="spGrid"></div>
</div>
<div id="stickerPickerBg" style="display:none;position:fixed;inset:0;z-index:709;" onclick="closeStickerPicker()"></div>

<!-- MODALS -->
<!-- Post Story -->
<div class="modal center" id="postStoryModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('postStoryModal')">‚úï</button>
    <div class="modal-title">Novo Story</div>
    <div class="modal-field"><label>Texto (opcional)</label><textarea id="storyTextInput" rows="3" placeholder="O que voc√™ quer compartilhar?"></textarea></div>
    <div id="storyImgPreview" style="margin-bottom:.7rem;border-radius:12px;overflow:hidden;max-height:200px;display:none;"><img id="storyImgPreviewImg" style="width:100%;object-fit:cover;max-height:200px;"></div>
    <button class="modal-btn secondary" onclick="document.getElementById('storyImgFileInput').click()">üì∑ Adicionar foto</button>
    <input type="file" id="storyImgFileInput" accept="image/*" style="display:none" onchange="previewStoryImg(this)">
    <button class="modal-btn" onclick="postStory()">Publicar</button>
  </div>
</div>

<!-- Add Friend -->
<div class="modal center" id="addFriendModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('addFriendModal')">‚úï</button>
    <div class="modal-title">Adicionar amigo</div>
    <div class="modal-field"><label>Nome do usu√°rio</label><input id="findUserInput" placeholder="Nome exato..." oninput="debounceSearch()"></div>
    <div id="findUserResult"></div>
  </div>
</div>

<!-- Create Group -->
<div class="modal center" id="createGroupModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('createGroupModal')">‚úï</button>
    <div class="modal-title">Criar Grupo</div>
    <div style="display:flex;align-items:center;gap:.8rem;margin-bottom:.9rem;">
      <div class="avatar sz-lg" id="groupAvatarPreview" style="background:var(--s4);cursor:pointer;font-size:1.5rem;" onclick="document.getElementById('groupImgInput').click()">üì∑</div>
      <input type="file" id="groupImgInput" accept="image/*" style="display:none" onchange="previewGroupImg(this)">
      <small style="color:var(--t2);">Foto do grupo (opcional)</small>
    </div>
    <div class="modal-field"><label>Nome do grupo</label><input id="groupNameInput" placeholder="Nome do grupo..."></div>
    <div class="modal-field"><label>Descri√ß√£o</label><textarea id="groupDescInput" rows="2" placeholder="Descri√ß√£o..."></textarea></div>
    <div class="modal-field"><label>Adicionar membros</label><div class="member-list-pick" id="memberPickList"></div></div>
    <button class="modal-btn" onclick="createGroup()">Criar grupo</button>
  </div>
</div>

<!-- Who liked/viewed -->
<div class="modal center" id="whoModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('whoModal')">‚úï</button>
    <div class="modal-title" id="whoModalTitle">Curtidas</div>
    <div class="who-list" id="whoList"></div>
  </div>
</div>

<!-- Profile View -->
<div id="profileView">
  <div class="pv-box" style="position:relative;">
    <button class="pv-close" onclick="closeProfileView()">‚úï</button>
    <div class="avatar sz-xl" id="pvAvatar"></div>
    <div class="pv-name" id="pvName"></div>
    <div class="pv-bio" id="pvBio"></div>
    <div class="pv-actions">
      <button class="pv-add-btn" id="pvAddBtn" onclick="addFriendFromView()">‚ûï Adicionar</button>
      <button class="pv-msg-btn" id="pvMsgBtn" onclick="msgFromView()">üí¨ Mensagem</button>
    </div>
  </div>
</div>

<!-- Group Info -->
<div class="modal center" id="groupInfoModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('groupInfoModal')">‚úï</button>
    <div style="display:flex;flex-direction:column;align-items:center;gap:.7rem;margin-bottom:1rem;">
      <div class="avatar sz-xl" id="giAvatar"></div>
      <div style="font-size:1.2rem;font-weight:800;" id="giName"></div>
      <div style="color:var(--t2);font-size:.85rem;text-align:center;" id="giDesc"></div>
    </div>
    <div class="modal-title" style="font-size:.9rem;">Membros</div>
    <div id="giMembers"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, getDocs, where, arrayUnion, arrayRemove, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDf7weRTKZ7voHRuLOzCcpn1Lh-sxbkykQ",
  authDomain: "flutter-ai-playground-da944.firebaseapp.com",
  projectId: "flutter-ai-playground-da944",
  storageBucket: "flutter-ai-playground-da944.firebasestorage.app",
  messagingSenderId: "332231299192",
  appId: "1:332231299192:web:53d9f26a631fd608071d8d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ‚îÄ‚îÄ‚îÄ GLOBALS ‚îÄ‚îÄ‚îÄ
let ME = null; // {uid, name, color, photoURL, bio, friends:[]}
let storyImgDataURL = null;
let groupImgDataURL = null;
let currentChatUid = null;
let currentChatIsGroup = false;
let chatUnsubscribe = null;
let storiesUnsubscribe = null;
let friendsChatsUnsub = null;
let svStories = []; let svIndex = 0; let svTimer = null;
let svCurrentId = null;
let flappyRunning = false;
let flappyAnim = null;
let stickerPickerTarget = 'chat'; // 'chat' or 'group'
let pvCurrentUid = null;
let currentGroupId = null;
let searchDebounce = null;

const COLORS = ['#a78bfa','#f472b6','#34d399','#fb923c','#60a5fa','#f9a8d4','#a3e635'];
function uidColor(uid){ let h=0; for(let c of (uid||'')) h=(h+c.charCodeAt(0))%COLORS.length; return COLORS[h]; }
function initials(name){ return (name||'?').slice(0,2).toUpperCase(); }
function timeSince(ts){
  if(!ts) return '';
  const d=Date.now()-(ts.toMillis?ts.toMillis():ts), m=60000,h=3600000,dy=86400000;
  if(d<m) return 'agora'; if(d<h) return Math.floor(d/m)+'min'; if(d<dy) return Math.floor(d/h)+'h'; return Math.floor(d/dy)+'d';
}
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2200);
}
function setAvatar(el, name, photoURL, uid){
  if(photoURL){ el.innerHTML=`<img src="${photoURL}" alt="">`; el.style.background='transparent'; }
  else { el.textContent=initials(name); el.style.background=uidColor(uid||name); }
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
window.doAuth = async function(){
  const name = document.getElementById('authName').value.trim();
  const pass = document.getElementById('authPass').value;
  if(!name||!pass){ showAuthErr('Preencha tudo!'); return; }
  if(pass.length<6){ showAuthErr('Senha deve ter 6+ caracteres'); return; }
  const email = name.toLowerCase().replace(/\s+/g,'_')+'@bobchat.app';
  const btn = document.getElementById('authSubmit');
  btn.textContent='Entrando...'; btn.disabled=true;
  try {
    let cred;
    try { cred = await signInWithEmailAndPassword(auth, email, pass); }
    catch(e){
      if(e.code==='auth/user-not-found'||e.code==='auth/invalid-credential'||e.code==='auth/wrong-password'){
        cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db,'users',cred.user.uid),{ name, color:uidColor(cred.user.uid), bio:'', friends:[], photoURL:null, createdAt:serverTimestamp() });
      } else throw e;
    }
  } catch(e){
    showAuthErr(e.code==='auth/wrong-password'?'Senha incorreta!':e.message);
    btn.textContent='Entrar / Criar conta'; btn.disabled=false;
  }
};
function showAuthErr(msg){ const e=document.getElementById('authErr'); e.textContent=msg; e.style.display='block'; setTimeout(()=>e.style.display='none',3000); }
window.doLogout = async function(){ await signOut(auth); };

onAuthStateChanged(auth, async user => {
  document.getElementById('splash').classList.add('hide');
  if(user){
    const snap = await getDoc(doc(db,'users',user.uid));
    if(!snap.exists()){ await setDoc(doc(db,'users',user.uid),{name:user.email.split('@')[0],color:uidColor(user.uid),bio:'',friends:[],photoURL:null,createdAt:serverTimestamp()}); }
    ME = { uid:user.uid, ...snap.data() };
    if(!ME.friends) ME.friends=[];
    document.getElementById('authScreen').style.display='none';
    document.getElementById('app').classList.add('on');
    initMain();
  } else {
    ME=null;
    document.getElementById('authScreen').style.display='flex';
    document.getElementById('app').classList.remove('on');
    document.getElementById('authSubmit').textContent='Entrar / Criar conta';
    document.getElementById('authSubmit').disabled=false;
  }
});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
function initMain(){
  listenStories();
  listenFriendsChats();
  renderProfilePage();
  cleanOldStories();
}

// ‚îÄ‚îÄ‚îÄ PAGE NAV ‚îÄ‚îÄ‚îÄ
window.showPage = function(id, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
};

// ‚îÄ‚îÄ‚îÄ STORIES ‚îÄ‚îÄ‚îÄ
async function cleanOldStories(){
  const cutoff = Date.now() - 24*60*60*1000;
  const q = query(collection(db,'stories'), orderBy('createdAt','asc'));
  const snap = await getDocs(q);
  snap.forEach(async d => {
    const ts = d.data().createdAt?.toMillis?.() || 0;
    if(ts < cutoff) await deleteDoc(doc(db,'stories',d.id));
  });
}

function listenStories(){
  if(storiesUnsubscribe) storiesUnsubscribe();
  const q = query(collection(db,'stories'), orderBy('createdAt','desc'), limit(100));
  storiesUnsubscribe = onSnapshot(q, snap => {
    const stories = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderStoriesBubbles(stories);
    renderStoriesFeed(stories);
  });
}

async function renderStoriesBubbles(stories){
  const cutoff = Date.now() - 24*60*60*1000;
  const valid = stories.filter(s=>{ const ts=s.createdAt?.toMillis?.()??0; return ts>cutoff; });
  const byUser = {};
  valid.forEach(s=>{ if(!byUser[s.uid]) byUser[s.uid]=[]; byUser[s.uid].push(s); });
  const container = document.getElementById('storiesBubbles');
  // keep add btn
  const addBtn = container.querySelector('.s-add-btn');
  container.innerHTML=''; container.appendChild(addBtn);
  // my story first
  const allUids = [ME.uid, ...Object.keys(byUser).filter(u=>u!==ME.uid)];
  for(const uid of allUids){
    const uStories = byUser[uid];
    if(!uStories && uid!==ME.uid) continue;
    const uData = uid===ME.uid ? ME : await getUserData(uid);
    const seen = (uStories||[]).every(s=>(s.views||[]).includes(ME.uid));
    const isMine = uid===ME.uid;
    const div = document.createElement('div');
    div.className='s-bubble';
    div.onclick = () => uStories?.length ? openSV(uStories) : openPostStoryModal();
    div.innerHTML=`<div class="s-ring ${seen&&!isMine?'seen':''} ${isMine?'mine':''}">
      <div class="s-ring-inner" id="sbring-${uid}"></div></div>
      <span class="s-bubble-name">${isMine?'Voc√™':uData?.name||'?'}</span>`;
    container.appendChild(div);
    setTimeout(()=>{ const el=document.getElementById('sbring-'+uid); if(el) setAvatar(el,uData?.name||'?',uData?.photoURL,uid); },0);
  }
}

async function renderStoriesFeed(stories){
  const cutoff = Date.now()-24*60*60*1000;
  const valid = stories.filter(s=>{ const ts=s.createdAt?.toMillis?.()??0; return ts>cutoff; });
  const feed = document.getElementById('storiesFeed');
  feed.innerHTML='';
  if(!valid.length){ feed.innerHTML='<div class="empty-s"><span>üìñ</span><p>Nenhum story ainda ‚Äî seja o primeiro!</p></div>'; return; }
  for(const s of valid){
    const uData = s.uid===ME.uid ? ME : await getUserData(s.uid);
    const liked = (s.likes||[]).includes(ME.uid);
    const card = document.createElement('div');
    card.className='story-card'; card.id='scard-'+s.id;
    card.innerHTML=`
      ${s.imgURL?`<div class="story-card-media"><img src="${s.imgURL}" alt="" loading="lazy"></div>`:''}
      <div class="story-card-body">
        <div class="story-card-user">
          <div class="avatar sz-sm" id="scav-${s.id}"></div>
          <strong>${uData?.name||'?'}</strong>
          <small>${timeSince(s.createdAt)}</small>
        </div>
        ${s.text?`<div class="story-card-text">${s.text}</div>`:''}
        <div class="story-card-actions">
          <button class="like-btn ${liked?'liked':''}" onclick="toggleLike(event,'${s.id}')">
            <span class="heart">${liked?'‚ù§Ô∏è':'ü§ç'}</span> <span id="lcount-${s.id}">${(s.likes||[]).length}</span>
          </button>
          <span class="views-count" onclick="showWhoLiked(event,'${s.id}')">‚ù§Ô∏è ${(s.likes||[]).length} curtidas</span>
          <span class="views-count" onclick="showStoryViewers(event,'${s.id}')" style="margin-left:.3rem">üëÅ ${(s.views||[]).length} views</span>
        </div>
      </div>`;
    card.querySelector('.story-card-media, .story-card-body')?.addEventListener('click', e=>{
      if(!e.target.closest('.story-card-actions')) openSV([s]);
    });
    feed.appendChild(card);
    setTimeout(()=>{ const el=document.getElementById('scav-'+s.id); if(el) setAvatar(el,uData?.name||'?',uData?.photoURL,s.uid); },0);
  }
}

// ‚îÄ‚îÄ‚îÄ POST STORY ‚îÄ‚îÄ‚îÄ
window.openPostStoryModal = function(){ storyImgDataURL=null; document.getElementById('storyTextInput').value=''; document.getElementById('storyImgPreview').style.display='none'; openModal('postStoryModal'); };
window.previewStoryImg = function(input){
  const f=input.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=e=>{ storyImgDataURL=e.target.result; document.getElementById('storyImgPreviewImg').src=e.target.result; document.getElementById('storyImgPreview').style.display='block'; }; r.readAsDataURL(f);
};
window.postStory = async function(){
  const text=document.getElementById('storyTextInput').value.trim();
  if(!text&&!storyImgDataURL){ showToast('Escreva algo ou adicione foto'); return; }
  closeModal('postStoryModal');
  let imgURL=null;
  if(storyImgDataURL){
    const r=ref(storage,`stories/${ME.uid}_${Date.now()}`);
    await uploadString(r,storyImgDataURL,'data_url');
    imgURL=await getDownloadURL(r);
  }
  await addDoc(collection(db,'stories'),{ uid:ME.uid, text, imgURL, likes:[], views:[], createdAt:serverTimestamp() });
  showToast('Story publicado! ‚ú®');
};

// ‚îÄ‚îÄ‚îÄ TOGGLE LIKE ‚îÄ‚îÄ‚îÄ
window.toggleLike = async function(e, sid){
  e.stopPropagation();
  const snap=await getDoc(doc(db,'stories',sid)); if(!snap.exists()) return;
  const likes=snap.data().likes||[];
  const liked=likes.includes(ME.uid);
  await updateDoc(doc(db,'stories',sid),{ likes: liked?arrayRemove(ME.uid):arrayUnion(ME.uid) });
};

// ‚îÄ‚îÄ‚îÄ STORY VIEWERS ‚îÄ‚îÄ‚îÄ
window.showStoryViewers = async function(e, sid){
  e.stopPropagation();
  const snap=await getDoc(doc(db,'stories',sid)); if(!snap.exists()) return;
  const views=snap.data().views||[];
  await showWhoList('Quem viu', views);
};
window.showWhoLiked = async function(e, sid){
  e.stopPropagation();
  const snap=await getDoc(doc(db,'stories',sid)); if(!snap.exists()) return;
  const likes=snap.data().likes||[];
  await showWhoList('Curtidas ‚ù§Ô∏è', likes);
};
async function showWhoList(title, uids){
  document.getElementById('whoModalTitle').textContent=title;
  const list=document.getElementById('whoList'); list.innerHTML='';
  for(const uid of uids){
    const u=await getUserData(uid);
    const div=document.createElement('div'); div.className='who-item';
    div.innerHTML=`<div class="avatar sz-sm" id="whoa-${uid}"></div><strong>${u?.name||'?'}</strong>`;
    list.appendChild(div);
    setTimeout(()=>{ const el=document.getElementById('whoa-'+uid); if(el) setAvatar(el,u?.name||'?',u?.photoURL,uid); },0);
  }
  if(!uids.length) list.innerHTML='<p style="color:var(--t2);font-size:.85rem;">Nenhum ainda</p>';
  openModal('whoModal');
}

// ‚îÄ‚îÄ‚îÄ STORY VIEWER ‚îÄ‚îÄ‚îÄ
window.openSV = function(stories){
  svStories=[...stories]; svIndex=0; renderSV();
  document.getElementById('storyViewer').classList.add('open');
};
function renderSV(){
  if(svIndex<0||svIndex>=svStories.length){ closeSV(); return; }
  clearTimeout(svTimer);
  const s=svStories[svIndex]; svCurrentId=s.id;
  // mark viewed
  if(!(s.views||[]).includes(ME.uid)) updateDoc(doc(db,'stories',s.id),{views:arrayUnion(ME.uid)}).catch(()=>{});
  // progress bars
  const prog=document.getElementById('svProgress'); prog.innerHTML='';
  svStories.forEach((_,i)=>{
    const bar=document.createElement('div'); bar.className='sv-prog-bar';
    const fill=document.createElement('div'); fill.className='sv-prog-fill'; fill.id='svpf-'+i;
    bar.appendChild(fill); prog.appendChild(bar);
  });
  for(let i=0;i<svIndex;i++){ const f=document.getElementById('svpf-'+i); if(f) f.style.width='100%'; }
  const curFill=document.getElementById('svpf-'+svIndex);
  if(curFill){ setTimeout(()=>{ curFill.style.transition='width 5s linear'; curFill.style.width='100%'; },50); }
  // media
  const img=document.getElementById('svImg'); const txt=document.getElementById('svText');
  if(s.imgURL){ img.src=s.imgURL; img.style.display='block'; txt.style.display='none'; }
  else { img.style.display='none'; txt.textContent=s.text; txt.style.display='block'; }
  // header
  getUserData(s.uid).then(u=>{
    const h=document.getElementById('svHeader');
    h.innerHTML=`<div class="avatar sz-sm" id="svhav"></div><strong style="color:#fff;font-size:.9rem;">${u?.name||'?'}</strong><small style="color:rgba(255,255,255,.6);margin-left:.4rem;font-size:.75rem;">${timeSince(s.createdAt)}</small>`;
    const el=document.getElementById('svhav'); if(el) setAvatar(el,u?.name||'?',u?.photoURL,s.uid);
  });
  // likes
  const liked=(s.likes||[]).includes(ME.uid);
  document.getElementById('svLikeBtn').className='sv-like-btn'+(liked?' liked':'');
  document.getElementById('svLikeBtn').textContent=liked?'‚ù§Ô∏è':'ü§ç';
  document.getElementById('svLikesCount').textContent=(s.likes||[]).length+' curtidas';
  document.getElementById('svViewersCount').textContent='üëÅ '+(s.views||[]).length;
  svTimer=setTimeout(svNext,5000);
}
window.svNext=function(){ clearTimeout(svTimer); svIndex++; renderSV(); };
window.svPrev=function(){ clearTimeout(svTimer); svIndex=Math.max(0,svIndex-1); renderSV(); };
window.closeSV=function(){ document.getElementById('storyViewer').classList.remove('open'); clearTimeout(svTimer); };
window.toggleSVLike=async function(){
  if(!svCurrentId) return;
  const snap=await getDoc(doc(db,'stories',svCurrentId)); if(!snap.exists()) return;
  const likes=snap.data().likes||[]; const liked=likes.includes(ME.uid);
  await updateDoc(doc(db,'stories',svCurrentId),{likes:liked?arrayRemove(ME.uid):arrayUnion(ME.uid)});
  svStories[svIndex].likes=liked?likes.filter(u=>u!==ME.uid):[...likes,ME.uid];
  renderSV();
};
window.showWhoViewed=function(){ showWhoList('Quem viu üëÅ',svStories[svIndex]?.views||[]); };

// ‚îÄ‚îÄ‚îÄ CHAT LIST ‚îÄ‚îÄ‚îÄ
function listenFriendsChats(){
  if(friendsChatsUnsub) friendsChatsUnsub();
  // Listen to all DM chats involving me
  const q1=query(collection(db,'chats'),where('members','array-contains',ME.uid));
  friendsChatsUnsub=onSnapshot(q1, async snap=>{
    const items=[];
    for(const d of snap.docs){
      const data=d.data();
      items.push({id:d.id,...data});
    }
    renderChatList(items);
  });
}

async function renderChatList(chats){
  const container=document.getElementById('chatListItems');
  const empty=document.getElementById('chatEmpty');
  if(!chats.length){ empty.style.display='flex'; container.innerHTML=''; container.appendChild(empty); return; }
  empty.style.display='none';
  // Sort by lastMsg time desc
  chats.sort((a,b)=>{ const ta=a.lastAt?.toMillis?.()??0; const tb=b.lastAt?.toMillis?.()??0; return tb-ta; });
  container.innerHTML='';
  for(const chat of chats){
    const isGroup=chat.type==='group';
    let name, photoURL, uid2;
    if(isGroup){ name=chat.name; photoURL=chat.photoURL; uid2=chat.id; }
    else {
      uid2=chat.members.find(u=>u!==ME.uid);
      const u=await getUserData(uid2);
      name=u?.name||'?'; photoURL=u?.photoURL;
    }
    const div=document.createElement('div');
    div.className='chat-item';
    div.innerHTML=`<div class="avatar sz-md" id="clav-${chat.id}"></div>
      <div class="chat-item-info">
        <strong>${name}${isGroup?` <span class="group-badge">Grupo</span>`:''}</strong>
        <small>${chat.lastMsg||'...'}</small>
      </div>
      <div class="chat-item-meta"><time>${timeSince(chat.lastAt)}</time></div>`;
    div.onclick=()=>{ if(isGroup) openGroupWin(chat.id,chat); else openChatWin(uid2); };
    container.appendChild(div);
    setTimeout(()=>{ const el=document.getElementById('clav-'+chat.id); if(el) setAvatar(el,name,photoURL,isGroup?chat.id:uid2); },0);
  }
}

window.filterChats=function(val){
  document.querySelectorAll('.chat-item').forEach(item=>{
    const name=item.querySelector('strong').textContent.toLowerCase();
    item.style.display=name.includes(val.toLowerCase())?'flex':'none';
  });
};

// ‚îÄ‚îÄ‚îÄ CHAT WINDOW ‚îÄ‚îÄ‚îÄ
window.openChatWin=async function(uid2){
  currentChatUid=uid2; currentChatIsGroup=false;
  const u=await getUserData(uid2);
  document.getElementById('cwName').textContent=u?.name||'?';
  document.getElementById('cwStatus').textContent='';
  const wrap=document.getElementById('cwAvatarWrap');
  wrap.innerHTML=`<div class="avatar sz-md" id="cwav"></div>`;
  setAvatar(document.getElementById('cwav'),u?.name||'?',u?.photoURL,uid2);
  document.getElementById('chatWin').classList.add('open');
  document.getElementById('cwMsgs').innerHTML='';
  if(chatUnsubscribe) chatUnsubscribe();
  // Get or create chat doc
  const chatId=getChatId(ME.uid,uid2);
  const chatRef=doc(db,'chats',chatId);
  const chatSnap=await getDoc(chatRef);
  if(!chatSnap.exists()) await setDoc(chatRef,{members:[ME.uid,uid2],type:'dm',lastMsg:'',lastAt:serverTimestamp()});
  currentGroupId=null;
  listenMessages(chatId,'cwMsgs');
};
window.closeChatWin=function(){ document.getElementById('chatWin').classList.remove('open'); if(chatUnsubscribe){chatUnsubscribe();chatUnsubscribe=null;} };
function getChatId(a,b){ return [a,b].sort().join('_'); }

function listenMessages(chatId, containerId){
  if(chatUnsubscribe) chatUnsubscribe();
  const q=query(collection(db,'chats',chatId,'messages'),orderBy('createdAt','asc'));
  chatUnsubscribe=onSnapshot(q, snap=>{
    const c=document.getElementById(containerId); c.innerHTML='';
    snap.docs.forEach(d=>appendMsg(d.data(), c));
    c.scrollTop=c.scrollHeight;
  });
}

function appendMsg(data, container){
  const isMe=data.uid===ME.uid;
  const div=document.createElement('div');
  div.className='msg-bubble '+(isMe?'me':'them');
  if(data.type==='sticker'){
    div.innerHTML=`<img class="msg-sticker" src="${data.content}" alt="sticker" onclick="window.open(this.src)">
      <span class="msg-time">${timeSince(data.createdAt)}</span>`;
  } else {
    div.innerHTML=`<div class="msg-inner">${escapeHtml(data.content)}</div>
      <span class="msg-time">${timeSince(data.createdAt)}</span>`;
  }
  container.appendChild(div);
}
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

window.sendMsg=async function(){
  const input=document.getElementById('cwInput');
  const text=input.value.trim(); if(!text) return;
  input.value=''; input.style.height='auto';
  const chatId=getChatId(ME.uid,currentChatUid);
  await addDoc(collection(db,'chats',chatId,'messages'),{ uid:ME.uid, content:text, type:'text', createdAt:serverTimestamp() });
  await updateDoc(doc(db,'chats',chatId),{ lastMsg:text, lastAt:serverTimestamp() });
};

window.openChatHeaderProfile=async function(){
  if(currentChatIsGroup) return;
  openProfileViewFor(currentChatUid);
};

// ‚îÄ‚îÄ‚îÄ GROUP WINDOW ‚îÄ‚îÄ‚îÄ
window.openGroupWin=function(groupId, groupData){
  currentGroupId=groupId; currentChatIsGroup=true;
  document.getElementById('gwName').textContent=groupData.name;
  document.getElementById('gwStatus').textContent=(groupData.members?.length||0)+' membros';
  const wrap=document.getElementById('gwAvatarWrap');
  wrap.innerHTML=`<div class="avatar sz-md" id="gwav"></div>`;
  setTimeout(()=>setAvatar(document.getElementById('gwav'),groupData.name,groupData.photoURL,groupId),0);
  document.getElementById('groupWin').classList.add('open');
  document.getElementById('gwMsgs').innerHTML='';
  if(chatUnsubscribe) chatUnsubscribe();
  listenGroupMessages(groupId);
};
window.closeGroupWin=function(){ document.getElementById('groupWin').classList.remove('open'); if(chatUnsubscribe){chatUnsubscribe();chatUnsubscribe=null;} };
function listenGroupMessages(groupId){
  if(chatUnsubscribe) chatUnsubscribe();
  const q=query(collection(db,'chats',groupId,'messages'),orderBy('createdAt','asc'));
  chatUnsubscribe=onSnapshot(q, snap=>{
    const c=document.getElementById('gwMsgs'); c.innerHTML='';
    snap.docs.forEach(d=>{ const data=d.data(); appendGroupMsg(data, c); });
    c.scrollTop=c.scrollHeight;
  });
}
function appendGroupMsg(data, container){
  const isMe=data.uid===ME.uid;
  const div=document.createElement('div');
  div.className='msg-bubble '+(isMe?'me':'them');
  if(data.type==='sticker'){
    div.innerHTML=`${!isMe?`<span style="font-size:.7rem;color:var(--t2);padding:0 .4rem 2px">${data.senderName}</span>`:''}
      <img class="msg-sticker" src="${data.content}" alt="sticker">
      <span class="msg-time">${timeSince(data.createdAt)}</span>`;
  } else {
    div.innerHTML=`${!isMe?`<span style="font-size:.7rem;color:var(--t2);padding:0 .4rem 2px">${data.senderName}</span>`:''}
      <div class="msg-inner">${escapeHtml(data.content)}</div>
      <span class="msg-time">${timeSince(data.createdAt)}</span>`;
  }
  container.appendChild(div);
}
window.sendGroupMsg=async function(){
  const input=document.getElementById('gwInput');
  const text=input.value.trim(); if(!text) return;
  input.value=''; input.style.height='auto';
  await addDoc(collection(db,'chats',currentGroupId,'messages'),{ uid:ME.uid, senderName:ME.name, content:text, type:'text', createdAt:serverTimestamp() });
  await updateDoc(doc(db,'chats',currentGroupId),{ lastMsg:ME.name+': '+text, lastAt:serverTimestamp() });
};

// ‚îÄ‚îÄ‚îÄ CREATE GROUP ‚îÄ‚îÄ‚îÄ
window.openCreateGroupModal=async function(){
  groupImgDataURL=null;
  document.getElementById('groupNameInput').value='';
  document.getElementById('groupDescInput').value='';
  document.getElementById('groupAvatarPreview').innerHTML='üì∑';
  document.getElementById('groupAvatarPreview').style.background='var(--s4)';
  // Load friends as member options
  const list=document.getElementById('memberPickList'); list.innerHTML='';
  for(const uid of (ME.friends||[])){
    const u=await getUserData(uid);
    const div=document.createElement('div'); div.className='member-pick-item';
    div.innerHTML=`<input type="checkbox" value="${uid}" id="mcheck-${uid}">
      <div class="avatar sz-sm" id="mpav-${uid}"></div>
      <label for="mcheck-${uid}" style="cursor:pointer">${u?.name||uid}</label>`;
    list.appendChild(div);
    setTimeout(()=>{ const el=document.getElementById('mpav-'+uid); if(el) setAvatar(el,u?.name||'?',u?.photoURL,uid); },0);
  }
  if(!(ME.friends||[]).length) list.innerHTML='<p style="color:var(--t2);font-size:.82rem;">Adicione amigos primeiro!</p>';
  openModal('createGroupModal');
};
window.previewGroupImg=function(input){
  const f=input.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=e=>{ groupImgDataURL=e.target.result;
    const el=document.getElementById('groupAvatarPreview');
    el.innerHTML=`<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
  }; r.readAsDataURL(f);
};
window.createGroup=async function(){
  const name=document.getElementById('groupNameInput').value.trim();
  const desc=document.getElementById('groupDescInput').value.trim();
  if(!name){ showToast('Digite o nome do grupo'); return; }
  const checked=[...document.querySelectorAll('#memberPickList input:checked')].map(c=>c.value);
  if(!checked.length){ showToast('Adicione ao menos 1 membro'); return; }
  const members=[ME.uid,...checked];
  let photoURL=null;
  if(groupImgDataURL){ const r=ref(storage,`groups/${Date.now()}`); await uploadString(r,groupImgDataURL,'data_url'); photoURL=await getDownloadURL(r); }
  const groupRef=await addDoc(collection(db,'chats'),{ type:'group', name, desc, photoURL, members, createdBy:ME.uid, createdAt:serverTimestamp(), lastMsg:'Grupo criado', lastAt:serverTimestamp() });
  closeModal('createGroupModal');
  showToast('Grupo criado! üéâ');
  openGroupWin(groupRef.id,{name,photoURL,members});
};

window.openGroupInfo=async function(){
  if(!currentGroupId) return;
  const snap=await getDoc(doc(db,'chats',currentGroupId)); if(!snap.exists()) return;
  const g=snap.data();
  const el=document.getElementById('giAvatar');
  setAvatar(el,g.name,g.photoURL,currentGroupId);
  document.getElementById('giName').textContent=g.name;
  document.getElementById('giDesc').textContent=g.desc||'';
  const members=document.getElementById('giMembers'); members.innerHTML='';
  for(const uid of (g.members||[])){
    const u=await getUserData(uid);
    const div=document.createElement('div'); div.style.cssText='display:flex;align-items:center;gap:.6rem;padding:.5rem 0;border-bottom:1px solid var(--border);';
    div.innerHTML=`<div class="avatar sz-sm" id="giav-${uid}"></div><strong style="font-size:.88rem">${u?.name||uid}</strong>${uid===g.createdBy?'<span style="color:var(--acc);font-size:.72rem;margin-left:auto">Admin</span>':''}`;
    members.appendChild(div);
    setTimeout(()=>{ const a=document.getElementById('giav-'+uid); if(a) setAvatar(a,u?.name||'?',u?.photoURL,uid); },0);
  }
  openModal('groupInfoModal');
};

// ‚îÄ‚îÄ‚îÄ STICKER PICKER ‚îÄ‚îÄ‚îÄ
window.openStickerPicker=function(){ stickerPickerTarget='chat'; loadStickerPicker(); document.getElementById('stickerPicker').classList.add('open'); document.getElementById('stickerPickerBg').style.display='block'; };
window.openStickerPickerGroup=function(){ stickerPickerTarget='group'; loadStickerPicker(); document.getElementById('stickerPicker').classList.add('open'); document.getElementById('stickerPickerBg').style.display='block'; };
window.closeStickerPicker=function(){ document.getElementById('stickerPicker').classList.remove('open'); document.getElementById('stickerPickerBg').style.display='none'; };
async function loadStickerPicker(){
  const snap=await getDoc(doc(db,'stickers',ME.uid));
  const stickers=snap.exists()?(snap.data().list||[]):[];
  const grid=document.getElementById('spGrid'); grid.innerHTML='';
  if(!stickers.length){ grid.innerHTML='<div class="sp-empty">Voc√™ n√£o tem figurinhas.<br>Adicione na aba Figurinhas! üé®</div>'; return; }
  stickers.forEach(url=>{
    const div=document.createElement('div'); div.className='sp-item';
    div.innerHTML=`<img src="${url}" alt="">`;
    div.onclick=()=>sendSticker(url);
    grid.appendChild(div);
  });
}
async function sendSticker(url){
  closeStickerPicker();
  if(stickerPickerTarget==='group'){
    if(!currentGroupId) return;
    await addDoc(collection(db,'chats',currentGroupId,'messages'),{uid:ME.uid,senderName:ME.name,content:url,type:'sticker',createdAt:serverTimestamp()});
    await updateDoc(doc(db,'chats',currentGroupId),{lastMsg:ME.name+': [Figurinha]',lastAt:serverTimestamp()});
  } else {
    if(!currentChatUid) return;
    const chatId=getChatId(ME.uid,currentChatUid);
    await addDoc(collection(db,'chats',chatId,'messages'),{uid:ME.uid,content:url,type:'sticker',createdAt:serverTimestamp()});
    await updateDoc(doc(db,'chats',chatId),{lastMsg:'[Figurinha]',lastAt:serverTimestamp()});
  }
}

// ‚îÄ‚îÄ‚îÄ STICKERS PAGE ‚îÄ‚îÄ‚îÄ
window.renderStickersPage=async function(){
  const snap=await getDoc(doc(db,'stickers',ME.uid));
  const stickers=snap.exists()?(snap.data().list||[]):[];
  const grid=document.getElementById('stickersGrid'); grid.innerHTML='';
  stickers.forEach((url,i)=>{
    const div=document.createElement('div'); div.className='sticker-item';
    div.innerHTML=`<img src="${url}" alt=""><button class="sticker-del" onclick="deleteSticker(${i})">‚úï</button>`;
    grid.appendChild(div);
  });
  if(!stickers.length) grid.innerHTML='<p style="color:var(--t2);font-size:.85rem;grid-column:1/-1;text-align:center;">Nenhuma figurinha ainda</p>';
};
window.uploadSticker=async function(input){
  const f=input.files[0]; if(!f) return;
  input.value='';
  const r=ref(storage,`stickers/${ME.uid}/${Date.now()}`);
  await uploadBytes(r,f); const url=await getDownloadURL(r);
  const snap=await getDoc(doc(db,'stickers',ME.uid));
  const list=snap.exists()?(snap.data().list||[]):[];
  list.push(url);
  await setDoc(doc(db,'stickers',ME.uid),{list});
  renderStickersPage();
  showToast('Figurinha adicionada! üé®');
};
window.deleteSticker=async function(idx){
  const snap=await getDoc(doc(db,'stickers',ME.uid));
  const list=snap.exists()?(snap.data().list||[]):[];
  list.splice(idx,1);
  await setDoc(doc(db,'stickers',ME.uid),{list});
  renderStickersPage();
};

// ‚îÄ‚îÄ‚îÄ ADD FRIEND ‚îÄ‚îÄ‚îÄ
window.openAddFriendModal=function(){ document.getElementById('findUserInput').value=''; document.getElementById('findUserResult').innerHTML=''; openModal('addFriendModal'); };
window.debounceSearch=function(){ clearTimeout(searchDebounce); searchDebounce=setTimeout(findUser,600); };
async function findUser(){
  const val=document.getElementById('findUserInput').value.trim(); if(!val) return;
  const res=document.getElementById('findUserResult');
  const q=query(collection(db,'users'),where('name','==',val));
  const snap=await getDocs(q);
  res.innerHTML='';
  if(snap.empty){ res.innerHTML='<p style="color:var(--t2);font-size:.82rem;">Usu√°rio n√£o encontrado</p>'; return; }
  snap.forEach(d=>{
    if(d.id===ME.uid) return;
    const u=d.data(); const uid=d.id;
    const isFriend=(ME.friends||[]).includes(uid);
    res.innerHTML=`<div class="find-user-result">
      <div class="avatar sz-md" id="frav"></div>
      <strong>${u.name}</strong>
      ${isFriend?'<span style="color:var(--acc3);font-size:.8rem;">‚úì Amigo</span>':`<button class="pv-add-btn" onclick="addFriend('${uid}')">Adicionar</button>`}
    </div>`;
    setTimeout(()=>{ const el=document.getElementById('frav'); if(el) setAvatar(el,u.name,u.photoURL,uid); },0);
  });
}
window.addFriend=async function(uid2){
  await updateDoc(doc(db,'users',ME.uid),{friends:arrayUnion(uid2)});
  await updateDoc(doc(db,'users',uid2),{friends:arrayUnion(ME.uid)});
  ME.friends=[...(ME.friends||[]),uid2];
  showToast('Amigo adicionado! üéâ');
  closeModal('addFriendModal');
  listenFriendsChats();
};

// ‚îÄ‚îÄ‚îÄ PROFILE PAGE ‚îÄ‚îÄ‚îÄ
window.renderProfilePage=async function(){
  if(!ME) return;
  const snap=await getDoc(doc(db,'users',ME.uid));
  if(snap.exists()){ ME={uid:ME.uid,...snap.data()}; if(!ME.friends) ME.friends=[]; }
  const av=document.getElementById('profileAvatarDisplay');
  setAvatar(av,ME.name,ME.photoURL,ME.uid);
  av.style.width='80px'; av.style.height='80px'; av.style.fontSize='1.4rem';
  document.getElementById('profileNameDisplay').textContent=ME.name;
  document.getElementById('profileBioInput').value=ME.bio||'';
  // Stats
  const storiesSnap=await getDocs(query(collection(db,'stories'),where('uid','==',ME.uid)));
  document.getElementById('statStories').textContent=storiesSnap.size;
  document.getElementById('statFriends').textContent=(ME.friends||[]).length;
  const lbSnap=await getDoc(doc(db,'leaderboard',ME.uid));
  document.getElementById('statScore').textContent=lbSnap.exists()?(lbSnap.data().flappy||0):0;
  // Friends list
  const fl=document.getElementById('friendsList'); fl.innerHTML='';
  for(const uid of (ME.friends||[])){
    const u=await getUserData(uid);
    const div=document.createElement('div'); div.className='friend-chip';
    div.innerHTML=`<div class="avatar sz-sm" id="flav-${uid}"></div><strong>${u?.name||uid}</strong>`;
    div.onclick=()=>openProfileViewFor(uid);
    fl.appendChild(div);
    setTimeout(()=>{ const el=document.getElementById('flav-'+uid); if(el) setAvatar(el,u?.name||'?',u?.photoURL,uid); },0);
  }
  if(!(ME.friends||[]).length) fl.innerHTML='<p style="color:var(--t2);font-size:.85rem;">Nenhum amigo ainda</p>';
};
window.saveBio=async function(){
  const bio=document.getElementById('profileBioInput').value.trim().slice(0,120);
  await updateDoc(doc(db,'users',ME.uid),{bio}); ME.bio=bio;
  showToast('Bio salva!');
};
window.uploadAvatar=async function(input){
  const f=input.files[0]; if(!f) return;
  const r=ref(storage,`avatars/${ME.uid}`);
  await uploadBytes(r,f); const url=await getDownloadURL(r);
  await updateDoc(doc(db,'users',ME.uid),{photoURL:url}); ME.photoURL=url;
  renderProfilePage();
  showToast('Foto atualizada! üì∏');
};

// ‚îÄ‚îÄ‚îÄ PROFILE VIEW ‚îÄ‚îÄ‚îÄ
window.openProfileViewFor=async function(uid){
  if(!uid||uid===ME.uid) return;
  pvCurrentUid=uid;
  const u=await getUserData(uid);
  const av=document.getElementById('pvAvatar');
  setAvatar(av,u?.name||'?',u?.photoURL,uid);
  av.style.width='80px'; av.style.height='80px'; av.style.fontSize='1.4rem';
  document.getElementById('pvName').textContent=u?.name||'?';
  document.getElementById('pvBio').textContent=u?.bio||'';
  const isFriend=(ME.friends||[]).includes(uid);
  document.getElementById('pvAddBtn').textContent=isFriend?'‚úì Amigo':'‚ûï Adicionar';
  document.getElementById('pvAddBtn').disabled=isFriend;
  document.getElementById('profileView').classList.add('open');
};
window.closeProfileView=function(){ document.getElementById('profileView').classList.remove('open'); };
window.addFriendFromView=async function(){
  if(!pvCurrentUid) return;
  await addFriend(pvCurrentUid);
  closeProfileView();
};
window.msgFromView=function(){
  if(!pvCurrentUid) return;
  closeProfileView();
  openChatWin(pvCurrentUid);
  showPage('chatPage', document.querySelectorAll('.bnav-btn')[1]);
};

// ‚îÄ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ‚îÄ
window.loadLeaderboard=async function(){
  const snap=await getDocs(collection(db,'leaderboard'));
  const scores=[];
  snap.forEach(d=>{ const data=d.data(); scores.push({uid:d.id,score:data.flappy||0,name:data.name||d.id}); });
  scores.sort((a,b)=>b.score-a.score);
  const list=document.getElementById('leaderboardList'); list.innerHTML='';
  if(!scores.filter(s=>s.score>0).length){ list.innerHTML='<p style="color:var(--t2);font-size:.85rem;">Nenhuma pontua√ß√£o ainda ‚Äî seja o primeiro!</p>'; return; }
  scores.filter(s=>s.score>0).slice(0,20).forEach((s,i)=>{
    const rankClass=i===0?'gold':i===1?'silver':i===2?'bronze':'';
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    list.innerHTML+=`<div class="lb-item">
      <span class="lb-rank ${rankClass}">${medal||i+1}</span>
      <div class="avatar sz-sm" id="lbav-${s.uid}"></div>
      <strong style="font-size:.88rem">${s.name}</strong>
      <span class="lb-score">${s.score.toLocaleString()}</span>
    </div>`;
    setTimeout(async()=>{ const u=await getUserData(s.uid); const el=document.getElementById('lbav-'+s.uid); if(el) setAvatar(el,s.name,u?.photoURL,s.uid); },0);
  });
};

// ‚îÄ‚îÄ‚îÄ FLAPPY BIRD ‚îÄ‚îÄ‚îÄ
let flappy={bird:{y:0,vy:0},pipes:[],score:0,frame:0,state:'idle'};
window.openFlappy=function(){
  document.getElementById('flappyWin').classList.add('open');
  document.getElementById('flappyOverlay').classList.remove('hidden');
  document.getElementById('flappyFinalScore').style.display='none';
  document.getElementById('flappyScore').style.display='none';
  document.getElementById('flappyStartBtn').textContent='Toque para jogar';
  const canvas=document.getElementById('flappyCanvas');
  canvas.onclick=flappyTap;
  document.getElementById('flappyWin').onclick=flappyTap;
};
window.closeFlappy=function(){ document.getElementById('flappyWin').classList.remove('open'); cancelAnimationFrame(flappyAnim); flappyRunning=false; };
window.startFlappy=function(){
  const canvas=document.getElementById('flappyCanvas');
  const wrap=canvas.parentElement;
  canvas.width=wrap.clientWidth; canvas.height=wrap.clientHeight;
  flappy={bird:{x:80,y:canvas.height/2,vy:0,r:18},pipes:[],score:0,frame:0,state:'running',lastPipe:0};
  document.getElementById('flappyOverlay').classList.add('hidden');
  document.getElementById('flappyScore').style.display='block';
  document.getElementById('flappyScore').textContent='0';
  flappyRunning=true;
  cancelAnimationFrame(flappyAnim);
  flappyLoop();
};
function flappyTap(e){
  if(e.target.closest('#flappyOverlay')) return;
  if(flappy.state==='running') flappy.bird.vy=-9;
  else if(flappy.state==='dead') startFlappy();
}
function flappyLoop(){
  if(!flappyRunning) return;
  const canvas=document.getElementById('flappyCanvas');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  const b=flappy.bird;
  // physics
  b.vy+=0.45; b.y+=b.vy;
  if(b.y+b.r>H||b.y-b.r<0){ flappyDie(); return; }
  // spawn pipes
  flappy.frame++;
  if(flappy.frame-flappy.lastPipe>90){
    flappy.lastPipe=flappy.frame;
    const gap=H*0.28; const minY=H*0.15; const topH=minY+Math.random()*(H-gap-minY*2);
    flappy.pipes.push({x:W,topH,gap,passed:false});
  }
  // move pipes
  flappy.pipes=flappy.pipes.filter(p=>p.x>-60);
  const pw=50;
  for(const p of flappy.pipes){
    p.x-=3.5;
    if(!p.passed&&p.x+pw<b.x){ p.passed=true; flappy.score++; document.getElementById('flappyScore').textContent=flappy.score; }
    if(b.x+b.r>p.x&&b.x-b.r<p.x+pw){
      if(b.y-b.r<p.topH||b.y+b.r>p.topH+p.gap){ flappyDie(); return; }
    }
  }
  // draw
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#1a2a4a'); grad.addColorStop(1,'#0a1a2a');
  ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
  // pipes
  for(const p of flappy.pipes){
    ctx.fillStyle='#22c55e';
    ctx.beginPath(); ctx.roundRect(p.x,0,pw,p.topH,6); ctx.fill();
    ctx.fillStyle='#16a34a';
    ctx.fillRect(p.x-4,p.topH-20,pw+8,20);
    ctx.fillStyle='#22c55e';
    ctx.beginPath(); ctx.roundRect(p.x,p.topH+p.gap,pw,H,6); ctx.fill();
    ctx.fillStyle='#16a34a';
    ctx.fillRect(p.x-4,p.topH+p.gap,pw+8,20);
  }
  // bird
  ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(Math.min(Math.max(b.vy*0.05,-0.5),0.5));
  ctx.font=`${b.r*2.2}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('üê¶',0,0); ctx.restore();
  flappyAnim=requestAnimationFrame(flappyLoop);
}
async function flappyDie(){
  flappyRunning=false;
  const score=flappy.score;
  document.getElementById('flappyScore').style.display='none';
  document.getElementById('flappyOverlay').classList.remove('hidden');
  document.getElementById('flappyFinalScore').textContent=score; document.getElementById('flappyFinalScore').style.display='block';
  document.getElementById('flappyStartBtn').textContent='Jogar de novo';
  // Save score if best
  const lbRef=doc(db,'leaderboard',ME.uid);
  const snap=await getDoc(lbRef);
  const prev=snap.exists()?(snap.data().flappy||0):0;
  if(score>prev) await setDoc(lbRef,{flappy:score,name:ME.name},{merge:true});
}

// ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ
window.openModal=function(id){ document.getElementById(id).classList.add('open'); };
window.closeModal=function(id){ document.getElementById(id).classList.remove('open'); };
document.querySelectorAll('.modal').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('open'); }));

// ‚îÄ‚îÄ‚îÄ CACHE ‚îÄ‚îÄ‚îÄ
const userCache={};
async function getUserData(uid){
  if(!uid) return null;
  if(userCache[uid]&&Date.now()-userCache[uid]._ts<60000) return userCache[uid];
  const snap=await getDoc(doc(db,'users',uid));
  if(snap.exists()){ const d={uid,...snap.data(),_ts:Date.now()}; userCache[uid]=d; return d; }
  return null;
}

// Keyboard events
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeSV(); closeChatWin(); closeGroupWin(); closeProfileView(); document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open')); } });

// PolyfillroundRect for older safari
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){this.beginPath();this.moveTo(x+r,y);this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();return this;};
}

console.log('‚úÖ BobChat ready!');
</script>
</body>
</html>
